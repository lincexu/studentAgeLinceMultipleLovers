using System;
using System.Collections.Generic;
using System.Linq;
using System.Runtime.CompilerServices;
using Config;
using Effect;
using Increase;
using MessagePack;
using Sdk;
using Sdk.PlatformAPI;
using TheEntity;
using UnityEngine;
using View.Main;

// Token: 0x020000AD RID: 173
public class RelationData : BaseData, IRedpoint
{
	// Token: 0x06000665 RID: 1637 RVA: 0x00039D28 File Offset: 0x00037F28
	public bool ChangeRelation(int _roleId, int _relationId, string _tag = null, bool _focusBefore = false)
	{
		Role role = Singleton<RoleMgr>.Ins.GetRole(_roleId);
		if (_relationId == 520)
		{
			Singleton<RoleMgr>.Ins.GetLoveData().SetLover(_roleId);
			return true;
		}
		if (role.Relation == _relationId)
		{
			return false;
		}
		Role role2 = Singleton<RoleMgr>.Ins.GetRole();
		int relation = role.Relation;
		if (this.relationDict.ContainsKey(role.Relation))
		{
			this.relationDict[role.Relation].Remove(_roleId);
		}
		role.Relation = _relationId;
		this.AddRelation(_relationId, _roleId, false);
		this.RefreshSocialCapacity();
		if (_focusBefore)
		{
			Singleton<RecordMgr>.Ins.AddRecord(4, _tag, new float[]
			{
				(float)_roleId,
				(float)_relationId
			});
			ToastHelper.Toast<string>(116, new string[]
			{
				role.Name,
				Cfg.RelationCfgMap[_relationId].name
			});
			return true;
		}
		Effector effector;
		if (role.relationEffector.TryGetValue(_relationId, out effector))
		{
			effector.Run(1f, false);
		}
		role2.IncCtrl.Run(RoleIncType.RelationTypeEffect, _relationId, 1f, ToStringMode.Default_Tag_Value, 0, false);
		float relationAchReward = this.GetRelationAchReward(_relationId);
		if (_relationId == -1)
		{
			return true;
		}
		role.canUnFocus = true;
		PersonGrowCfg personGrowCfg;
		if (relation < _relationId && _relationId == 6 && Cfg.PersonGrowCfgMap.TryGetValue(role.id, out personGrowCfg))
		{
			if (role.Trait2 > 0)
			{
				role.SetTrait2(role.Trait2);
			}
			else
			{
				role.SetTrait2(Cfg.PersonGrowCfgMap[role.id].trait);
			}
		}
		if (relation == 0)
		{
			role.RefreshPrimaryPersonalityId();
			role.SetMeetDay(Singleton<RoundMgr>.Ins.GetYear(), Singleton<RoundMgr>.Ins.GetMonth()[0]);
			Singleton<RoleMgr>.Ins.GetTelephoneData().AddPhone(role.id);
			IncreaserOther inc = new IncreaserOther(null)
			{
				toRoleId = 0,
				fromRoleId = role.id,
				otherAttrId = 218,
				tag = role.Name,
				id = 10
			};
			role2.AddEffect(RoleIncType.AttrEachRoundInc, 10, inc, null);
			IncreaserOther inc2 = new IncreaserOther(null)
			{
				toRoleId = 0,
				fromRoleId = role.id,
				otherAttrId = 216,
				tag = role.Name
			};
			role2.AddEffect(RoleIncType.AttrEachRoundInc, 3, inc2, null);
			IncreaserOther inc3 = new IncreaserOther(null)
			{
				toRoleId = 0,
				fromRoleId = role.id,
				otherAttrId = 226,
				tag = role.Name
			};
			role2.AddEffect(RoleIncType.AttrEachRoundInc, 100, inc3, null);
			if (role.Trait != 0)
			{
				role.SetTrait(role.Trait, true);
			}
			else if (role.Traits.NotEmpty<int>())
			{
				role.SetTrait(role.Traits[0], true);
			}
			else
			{
				role.SetTrait(Cfg.PersonGrowCfgMap[role.id].speciality, true);
			}
			BaseIncreaser baseIncreaser = role2.IncCtrl.Get(RoleIncType.AttrInc, 207);
			if (baseIncreaser != null)
			{
				role.UpdateFavor(baseIncreaser.GetValue(), 1f, null);
			}
			role.CheckSocialEvt();
			EventMgr.Send(3201);
		}
		else
		{
			Singleton<RoleMgr>.Ins.GetNeedsData().DoRelationUp(_tag);
			if (relation < _relationId && relationAchReward > 0f)
			{
				role2.UpdateAttr(3, relationAchReward, 1f, _tag, 2);
			}
			Singleton<RoleMgr>.Ins.UpdateConditionData(7, 8, 1f, 0);
			Singleton<RoleMgr>.Ins.UpdateConditionData(7, 0, (float)_roleId, 0);
			EventMgr.Send(3201);
		}
		Singleton<RecordMgr>.Ins.AddRecord(4, _tag, new float[]
		{
			(float)_roleId,
			(float)_relationId
		});
		if (_relationId != 0)
		{
			ToastHelper.Toast<string>(116, new string[]
			{
				role.Name,
				Cfg.RelationCfgMap[_relationId].name
			});
		}
		return true;
	}

	// Token: 0x06000666 RID: 1638 RVA: 0x0003A0D2 File Offset: 0x000382D2
	public List<int> GetRelationship(int _relationId)
	{
		if (this.relationDict.ContainsKey(_relationId))
		{
			return this.relationDict[_relationId];
		}
		return null;
	}

	// Token: 0x06000667 RID: 1639 RVA: 0x0003A0F0 File Offset: 0x000382F0
	public Dictionary<int, List<int>> GetAllRelationShip()
	{
		return this.relationDict;
	}

	// Token: 0x06000668 RID: 1640 RVA: 0x0003A0F8 File Offset: 0x000382F8
	public bool InRelationList(int _roleId, int _relationType)
	{
		foreach (KeyValuePair<int, List<int>> keyValuePair in this.relationDict)
		{
			if (keyValuePair.Key != 0 && (_relationType == -1 || _relationType == keyValuePair.Key) && keyValuePair.Value.Contains(_roleId))
			{
				return _relationType != 0;
			}
		}
		return _relationType == 0;
	}

	// Token: 0x06000669 RID: 1641 RVA: 0x0003A178 File Offset: 0x00038378
	public int GetRelationCnt(int _relationId, bool _contain = false)
	{
		if (_contain)
		{
			int num = 0;
			foreach (KeyValuePair<int, List<int>> keyValuePair in this.relationDict)
			{
				if (keyValuePair.Key >= _relationId)
				{
					num += keyValuePair.Value.Count;
				}
			}
			return num;
		}
		if (this.relationDict.ContainsKey(_relationId))
		{
			return this.relationDict[_relationId].Count;
		}
		return 0;
	}

	// Token: 0x0600066A RID: 1642 RVA: 0x0003A208 File Offset: 0x00038408
	public bool HasRelation()
	{
		foreach (KeyValuePair<int, List<int>> keyValuePair in this.relationDict)
		{
			if (keyValuePair.Key > 0 && keyValuePair.Key <= 6 && keyValuePair.Value.Count > 0)
			{
				return true;
			}
		}
		return false;
	}

	// Token: 0x0600066B RID: 1643 RVA: 0x0003A280 File Offset: 0x00038480
	public int GetSexRelationCnt(int _relationId, GenderDefine _sex)
	{
		if (!this.relationDict.ContainsKey(_relationId))
		{
			return 0;
		}
		int num = 0;
		foreach (int roleId in this.relationDict[_relationId])
		{
			Role role = Singleton<RoleMgr>.Ins.GetRole(roleId);
			if (role != null && role.Sex == _sex)
			{
				num++;
			}
		}
		return num;
	}

	// Token: 0x0600066C RID: 1644 RVA: 0x0003A304 File Offset: 0x00038504
	[return: TupleElementNames(new string[]
	{
		"roleId",
		"favor"
	})]
	public ValueTuple<int, float> GetFavorMax()
	{
		float num = 0f;
		int item = -1;
		foreach (KeyValuePair<int, List<int>> keyValuePair in this.relationDict)
		{
			if (keyValuePair.Key > 1 && keyValuePair.Key < 6)
			{
				foreach (int num2 in keyValuePair.Value)
				{
					Role role = Singleton<RoleMgr>.Ins.GetRole(num2);
					if (role != null && role.Favor > num)
					{
						num = role.Favor;
						item = num2;
					}
				}
			}
		}
		return new ValueTuple<int, float>(item, num);
	}

	// Token: 0x0600066D RID: 1645 RVA: 0x0003A3D8 File Offset: 0x000385D8
	public List<int> GetOtherRelation(int _type)
	{
		List<int> list = new List<int>();
		OtherRelationCfg otherRelationCfg = Cfg.OtherRelationCfgMap[_type];
		if (otherRelationCfg.groups.Count == 0)
		{
			return list;
		}
		foreach (int num in ((otherRelationCfg.groups[0] == -1) ? new List<int>(this.relationDict.Keys) : otherRelationCfg.groups))
		{
			if (num == -1 || this.relationDict.ContainsKey(num))
			{
				List<int> list2 = this.relationDict[num];
				if (_type != -12)
				{
					if (_type != -11)
					{
						switch (_type)
						{
						case 21:
						{
							float num2 = 0f;
							using (List<int>.Enumerator enumerator2 = list2.GetEnumerator())
							{
								while (enumerator2.MoveNext())
								{
									int num3 = enumerator2.Current;
									Role role = Singleton<RoleMgr>.Ins.GetRole(num3);
									if (role != null)
									{
										if (list.Count == 0)
										{
											list.Add(num3);
											num2 = role.Favor;
										}
										else if (role.Favor > num2)
										{
											num2 = role.Favor;
											list.Clear();
											list.Add(num3);
										}
										else if (role.Favor == num2)
										{
											list.Add(num3);
										}
									}
								}
								continue;
							}
							break;
						}
						case 22:
							break;
						case 23:
						{
							List<int> list3 = list2.FindAll((int _id) => Cfg.PersonCfgMap.ContainsKey(_id) && Singleton<RoleMgr>.Ins.GetRole(_id) != null && Cfg.PersonCfgMap[_id].gender != (int)Singleton<RoleMgr>.Ins.GetRole().Sex);
							if (list3.Count > 0)
							{
								float max = list3.Max((int id) => Singleton<RoleMgr>.Ins.GetRole(id).Favor);
								list = list3.FindAll((int id) => Singleton<RoleMgr>.Ins.GetRole(id).Favor == max);
							}
							if (list.NotEmpty<int>())
							{
								return list;
							}
							continue;
						}
						default:
							goto IL_2C5;
						}
						float num4 = 0f;
						using (List<int>.Enumerator enumerator2 = list2.GetEnumerator())
						{
							while (enumerator2.MoveNext())
							{
								int num5 = enumerator2.Current;
								Role role2 = Singleton<RoleMgr>.Ins.GetRole(num5);
								if (role2 != null)
								{
									if (list.Count == 0)
									{
										list.Add(num5);
										num4 = role2.Favor;
									}
									else if (role2.Favor < num4)
									{
										num4 = role2.Favor;
										list.Clear();
										list.Add(num5);
									}
									else if (role2.Favor == num4)
									{
										list.Add(num5);
									}
								}
							}
							continue;
						}
						IL_2C5:
						list.AddRange(list2);
					}
					else
					{
						list.AddRange(list2.FindAll((int _id) => Cfg.PersonCfgMap.ContainsKey(_id) && Singleton<RoleMgr>.Ins.GetRole(_id) != null && Cfg.PersonCfgMap[_id].gender == (int)Singleton<RoleMgr>.Ins.GetRole().Sex));
					}
				}
				else
				{
					list.AddRange(list2.FindAll((int _id) => Cfg.PersonCfgMap.ContainsKey(_id) && Singleton<RoleMgr>.Ins.GetRole(_id) != null && Cfg.PersonCfgMap[_id].gender != (int)Singleton<RoleMgr>.Ins.GetRole().Sex));
				}
			}
		}
		return list;
	}

	// Token: 0x0600066E RID: 1646 RVA: 0x0003A720 File Offset: 0x00038920
	public int GetOtherRelationCnt(int _type)
	{
		OtherRelationCfg otherRelationCfg = Cfg.OtherRelationCfgMap[_type];
		int cnt = 0;
		Role mainRole = null;
		List<int> list;
		if (otherRelationCfg.groups.Count > 0 && otherRelationCfg.groups[0] == -1)
		{
			list = new List<int>(Cfg.RelationCfgMap.Keys);
		}
		else
		{
			list = otherRelationCfg.groups;
		}
		if (list == null || list.Count == 0)
		{
			return 0;
		}
		Func<int, bool> <>9__0;
		Func<int, bool> <>9__1;
		foreach (int num in list)
		{
			if (_type != -12)
			{
				if (_type != -11)
				{
					if (_type - 21 > 1)
					{
						cnt += this.GetRelationCnt(num, false);
					}
					else
					{
						cnt = 1;
					}
				}
				else
				{
					IEnumerable<int> source = this.relationDict[num];
					Func<int, bool> predicate;
					if ((predicate = <>9__0) == null)
					{
						predicate = (<>9__0 = delegate(int _id)
						{
							if (Singleton<RoleMgr>.Ins.GetRole(_id).Sex == (mainRole ?? Singleton<RoleMgr>.Ins.GetRole()).Sex)
							{
								int cnt = cnt;
								cnt++;
								return true;
							}
							return false;
						});
					}
					source.All(predicate);
				}
			}
			else
			{
				IEnumerable<int> source2 = this.relationDict[num];
				Func<int, bool> predicate2;
				if ((predicate2 = <>9__1) == null)
				{
					predicate2 = (<>9__1 = delegate(int _id)
					{
						if (Singleton<RoleMgr>.Ins.GetRole(_id).Sex != (mainRole ?? Singleton<RoleMgr>.Ins.GetRole()).Sex)
						{
							int cnt = cnt;
							cnt++;
							return true;
						}
						return false;
					});
				}
				source2.All(predicate2);
			}
		}
		return cnt;
	}

	// Token: 0x0600066F RID: 1647 RVA: 0x0003A878 File Offset: 0x00038A78
	public void AddRelation(int _relationId, int _roleId, bool _sendEvt = true)
	{
		if (_roleId == 0)
		{
			return;
		}
		if (this.relationDict.ContainsKey(_relationId))
		{
			if (!this.relationDict[_relationId].Contains(_roleId))
			{
				this.relationDict[_relationId].Add(_roleId);
			}
		}
		else
		{
			this.relationDict.Add(_relationId, new List<int>
			{
				_roleId
			});
		}
		if (_relationId > 0 && _sendEvt)
		{
			EventMgr.Send(3201);
		}
		Singleton<GlobalMgr>.Ins.CheckAchievement(7, 0);
	}

	// Token: 0x06000670 RID: 1648 RVA: 0x0003A8F8 File Offset: 0x00038AF8
	public bool IsMatchRelationType(int _roleId, int _relationType)
	{
		Role role = Singleton<RoleMgr>.Ins.GetRole(_roleId);
		return role != null && this.IsMatchRelationType(role, _relationType);
	}

	// Token: 0x06000671 RID: 1649 RVA: 0x0003A920 File Offset: 0x00038B20
	public bool IsMatchRelationType(Role _role, int _relationType)
	{
		if (!Cfg.OtherRelationCfgMap.ContainsKey(_relationType))
		{
			return false;
		}
		if (_relationType == 520)
		{
			return Singleton<RoleMgr>.Ins.GetLoveData().loverId == _role.id;
		}
		if (_relationType == -1)
		{
			return true;
		}
		if (_relationType == -11)
		{
			return _role.Gender == Singleton<RoleMgr>.Ins.GetRole().Gender;
		}
		if (_relationType == -12)
		{
			return _role.Gender != Singleton<RoleMgr>.Ins.GetRole().Gender;
		}
		if (_relationType == 21)
		{
			List<int> otherRelation = this.GetOtherRelation(_relationType);
			if (otherRelation.Count > 0)
			{
				return _role.Favor == otherRelation.Max(delegate(int _id)
				{
					Role role = Singleton<RoleMgr>.Ins.GetRole(_id);
					if (role != null)
					{
						return role.Favor;
					}
					return 0f;
				});
			}
			return false;
		}
		else if (_relationType == 22)
		{
			List<int> otherRelation2 = this.GetOtherRelation(_relationType);
			if (otherRelation2.Count > 0)
			{
				return _role.Favor == otherRelation2.Min(delegate(int _id)
				{
					Role role = Singleton<RoleMgr>.Ins.GetRole(_id);
					if (role != null)
					{
						return role.Favor;
					}
					return 0f;
				});
			}
			return false;
		}
		else
		{
			if (_relationType != 23)
			{
				OtherRelationCfg otherRelationCfg = Cfg.OtherRelationCfgMap[_relationType];
				return otherRelationCfg.groups[0] == -1 || otherRelationCfg.groups.Contains(_role.Relation);
			}
			List<int> otherRelation3 = this.GetOtherRelation(-12);
			if (otherRelation3.Count > 0)
			{
				float num = otherRelation3.Max(delegate(int _id)
				{
					Role role = Singleton<RoleMgr>.Ins.GetRole(_id);
					if (role != null)
					{
						return role.Favor;
					}
					return 0f;
				});
				return _role.Favor == num;
			}
			return false;
		}
	}

	// Token: 0x06000672 RID: 1650 RVA: 0x0003AAA8 File Offset: 0x00038CA8
	public List<int> GetRelationType(Role _role)
	{
		List<int> list = new List<int>();
		foreach (KeyValuePair<int, OtherRelationCfg> keyValuePair in Cfg.OtherRelationCfgMap)
		{
			if (this.IsMatchRelationType(_role, keyValuePair.Key))
			{
				list.Add(keyValuePair.Key);
			}
		}
		return list;
	}

	// Token: 0x06000673 RID: 1651 RVA: 0x0003AB18 File Offset: 0x00038D18
	public bool IsNpcFavorLowerThan(float _v)
	{
		foreach (KeyValuePair<int, List<int>> keyValuePair in this.relationDict)
		{
			if (keyValuePair.Key != 0)
			{
				foreach (int roleId in keyValuePair.Value)
				{
					Role role = Singleton<RoleMgr>.Ins.GetRole(roleId);
					if (role != null && role.Favor < _v)
					{
						return true;
					}
				}
			}
		}
		return false;
	}

	// Token: 0x06000674 RID: 1652 RVA: 0x0003ABD0 File Offset: 0x00038DD0
	public float GetRelationAchReward(int _relation)
	{
		if (_relation < 2)
		{
			return 0f;
		}
		if (this.rewardIds == null)
		{
			this.rewardIds = new Dictionary<int, int>();
		}
		int num;
		if (!this.rewardIds.TryGetValue(_relation, out num))
		{
			num = 0;
		}
		num++;
		float num2 = 0f;
		if (Cfg.SocialAchievementCfgMap.ContainsKey(num))
		{
			this.rewardIds[_relation] = num;
			num2 = Cfg.SocialAchievementCfgMap[num].achievements[_relation - 2];
			Singleton<RoleMgr>.Ins.GetRole().UpdateAttr(100, num2, 1f, DescCtrl.GetFromTag<string>(34, new string[]
			{
				Cfg.RelationCfgMap[_relation].name
			}), 2);
		}
		return num2;
	}

	// Token: 0x06000675 RID: 1653 RVA: 0x0003AC84 File Offset: 0x00038E84
	public List<int> GetAllSocialNpcs(bool _includeDLC)
	{
		List<int> list = new List<int>();
		foreach (KeyValuePair<int, PersonCfg> keyValuePair in Cfg.PersonCfgMap)
		{
			if (this.IsNpcAppearInThisGame(keyValuePair.Key, _includeDLC))
			{
				Role role = Singleton<RoleMgr>.Ins.GetRole(keyValuePair.Key);
				if (role == null || role.Relation != -1)
				{
					list.Add(keyValuePair.Key);
				}
			}
		}
		return list;
	}

	// Token: 0x06000676 RID: 1654 RVA: 0x0003AD14 File Offset: 0x00038F14
	public bool IsNpcAppearInThisGame(int _id, bool _includeDLC = false)
	{
		PersonCfg personCfg = Cfg.PersonCfgMap[_id];
		if (personCfg.init.IsEmpty<int>() || personCfg.init[0] <= 1)
		{
			return false;
		}
		bool flag = Singleton<RoleMgr>.Ins.GetRole().Sex == GenderDefine.Male;
		if ((flag && personCfg.init[0] == 4) || (!flag && personCfg.init[0] == 3))
		{
			return false;
		}
		if (_id == 204 || _id == 103)
		{
			bool flag2 = Platform.Current.HasDLC(0) || _includeDLC;
			return true;
		}
		return true;
	}

	// Token: 0x06000677 RID: 1655 RVA: 0x0003ADA4 File Offset: 0x00038FA4
	public int GetUnknownFriendId()
	{
		List<int> otherRelation = this.GetOtherRelation(-2);
		if (otherRelation.Count == 0)
		{
			return -1;
		}
		otherRelation.OutOfOrder<int>();
		int result = -1;
		foreach (int num in otherRelation)
		{
			if (this.IsNpcAppearInThisGame(num, false) && ((num != 204 && num != 103) || (Singleton<DLCCtrl>.Ins.IsDLCLoaded(DLC_IDX.Chuyang) && Singleton<RoleMgr>.Ins.GetRole().IncCtrl.GetValue(RoleIncType.ToggleRole, num) != 0f)))
			{
				PersonCfg personCfg = Cfg.PersonCfgMap[num];
				if (!Singleton<RoleMgr>.Ins.GetRole(num).isLeave)
				{
					if (personCfg.gender != (int)Singleton<RoleMgr>.Ins.GetRole().Sex)
					{
						return num;
					}
					result = num;
				}
			}
		}
		return result;
	}

	// Token: 0x06000678 RID: 1656 RVA: 0x0003AE94 File Offset: 0x00039094
	public void ReFocusNpc(int _id)
	{
		this.searchFriendCnt++;
		Role role = Singleton<RoleMgr>.Ins.GetRole(_id);
		this.ChangeRelation(_id, role.relationBeforeUnfocus, null, true);
		Singleton<FuncMgr>.Ins.GetMapData().UpdateNpcMap(role, false);
		EventMgr.Send(401);
		EventMgr.Send(105);
	}

	// Token: 0x06000679 RID: 1657 RVA: 0x0003AEF0 File Offset: 0x000390F0
	public void MakeAcquaintances(int _id)
	{
		Role role = Singleton<RoleMgr>.Ins.GetRole(_id);
		this.searchFriendCnt++;
		if (this.searchFriendCnt == 1 && this.unFocusCnt == 0)
		{
			Singleton<RoleMgr>.Ins.GetRole().IncCtrl.Add(RoleIncType.AttrEachRoundInc, 11, new IncreaserAttr(null)
			{
				attrId = 11,
				value = 1f,
				tag = DescCtrl.GetTxt(922)
			});
		}
		if (this.specialMakeAcquinceMode > 0)
		{
			this.ChangeRelation(_id, 1, DescCtrl.GetFromTag(130), false);
			Singleton<RoleMgr>.Ins.GetRole(_id).UpdateFavor((float)this.specialMakeAcquinceMode, 1f, null);
			this.specialMakeAcquinceMode = 0;
		}
		else
		{
			this.ChangeRelation(_id, 1, DescCtrl.GetFromTag(130), false);
		}
		Singleton<FuncMgr>.Ins.GetMapData().UpdateNpcMap(role, false);
		if (role.socialEvtId > 0)
		{
			EventMgr.Send(401);
			Singleton<CommonEvtMgr>.Ins.ShowEvent(role.socialEvtId, 1f, null, 0, true, null);
			role.socialEvtId = 0;
			return;
		}
		if (role.loveSocialEvtId > 0)
		{
			EventMgr.Send(401);
			Singleton<CommonEvtMgr>.Ins.ShowEvent(role.loveSocialEvtId, 1f, null, 0, true, null);
			role.loveSocialEvtId = 0;
			return;
		}
		EventMgr.Send(401);
		EventMgr.Send(105);
	}

	// Token: 0x0600067A RID: 1658 RVA: 0x0003B04C File Offset: 0x0003924C
	public bool CanFocusNPC()
	{
		if (this.jumpFocusViewThisRound)
		{
			return false;
		}
		if (!Singleton<FuncMgr>.Ins.IsFuncOpened(42))
		{
			return false;
		}
		float searchFriendNeedEQ = this.GetSearchFriendNeedEQ();
		return searchFriendNeedEQ >= 0f && Singleton<RoleMgr>.Ins.HasEnoughCost(2, searchFriendNeedEQ, false) && this.GetUnknownFriendId() > 0;
	}

	// Token: 0x0600067B RID: 1659 RVA: 0x0003B09C File Offset: 0x0003929C
	public void ShowFocusNPCView()
	{
		this.jumpFocusViewThisRound = true;
		int unknownFriendId = this.GetUnknownFriendId();
		UIMgr.OpenView<DetailView>(UILayerType.None, null, new object[]
		{
			503,
			0,
			unknownFriendId
		});
		EventMgr.Send(105);
	}

	// Token: 0x0600067C RID: 1660 RVA: 0x0003B0EC File Offset: 0x000392EC
	public float GetSearchFriendNeedEQ()
	{
		if (this.specialMakeAcquinceMode > 0)
		{
			return 0f;
		}
		if (this.searchFriendCnt >= this.enableFocusCnt)
		{
			return -1f;
		}
		float result = -1f;
		if (Cfg.AcquaintancesNumberCfgMap.ContainsKey(this.searchFriendCnt + 1))
		{
			result = Cfg.AcquaintancesNumberCfgMap[this.searchFriendCnt + 1].target;
		}
		return result;
	}

	// Token: 0x0600067D RID: 1661 RVA: 0x0003B150 File Offset: 0x00039350
	public void NPCLeave(int _npcId, bool _forever = false, int _subType = 0)
	{
		Role role = Singleton<RoleMgr>.Ins.GetRole(_npcId);
		if (role == null)
		{
			return;
		}
		role.isLeave = true;
		role.leaveType = _subType;
		Singleton<FuncMgr>.Ins.GetMapData().RemoveNpcFromMap(_npcId);
		if (_forever)
		{
			this.searchFriendCnt--;
			this.ChangeRelation(_npcId, -1, null, false);
			Singleton<RecordMgr>.Ins.AddRecord(18, null, new float[]
			{
				(float)_npcId,
				-1f
			});
			ToastHelper.Toast<string>(175, new string[]
			{
				role.Name
			});
		}
		Singleton<RoleMgr>.Ins.GetPersonalityFuncData(true).SocialClubRemoveNpc(_npcId);
		Singleton<RoleMgr>.Ins.GetPersonalityFuncData(true).RemoveRequestByNpc(_npcId);
	}

	// Token: 0x0600067E RID: 1662 RVA: 0x0003B204 File Offset: 0x00039404
	public void NPCBack(int _npcId, int _mapId = 0)
	{
		Role role = Singleton<RoleMgr>.Ins.GetRole(_npcId);
		if (role == null)
		{
			return;
		}
		role.isLeave = false;
		role.leaveType = 0;
		if (_mapId > 0)
		{
			Singleton<FuncMgr>.Ins.GetMapData().UpdateNpcMap(_npcId, _mapId, false);
		}
		else
		{
			Singleton<FuncMgr>.Ins.GetMapData().UpdateNpcMap(_npcId);
		}
		Singleton<RoleMgr>.Ins.GetPersonalityFuncData(true).NpcBackToSocialClub(_npcId);
	}

	// Token: 0x0600067F RID: 1663 RVA: 0x0003B268 File Offset: 0x00039468
	public void UnFocus(int _npcId)
	{
		Role role = Singleton<RoleMgr>.Ins.GetRole(_npcId);
		if (role == null)
		{
			return;
		}
		this.unFocusCnt++;
		role.relationBeforeUnfocus = role.Relation;
		this.ChangeRelation(_npcId, 0, DescCtrl.GetFromTag(1224), false);
		role.unFocusCnt++;
		role.unFocusRound = Singleton<RoundMgr>.Ins.GetRound();
		Singleton<FuncMgr>.Ins.GetMapData().RemoveNpcFromMap(_npcId);
		Singleton<RoleMgr>.Ins.GetPersonalityFuncData(true).SocialClubRemoveNpc(_npcId);
		Singleton<RoleMgr>.Ins.GetPersonalityFuncData(true).RemoveRequestByNpc(_npcId);
		this.searchFriendCnt = Mathf.Max(0, this.searchFriendCnt - 1);
		if (role.unFocusEffectUid == 0UL)
		{
			IncreaserOther increaserOther = new IncreaserOther(null)
			{
				otherAttrId = 1402,
				id = _npcId,
				tag = DescCtrl.GetTxt(1224)
			};
			role.AddEffect(RoleIncType.OtherAttrEachRoundInc, 201, increaserOther, null);
			role.unFocusEffectUid = increaserOther.uid;
		}
		if (this.socialCntAddByDownFavorNpcUid == 0UL)
		{
			IncreaserOther increaserOther2 = new IncreaserOther(null)
			{
				otherAttrId = 229,
				tag = DescCtrl.GetTxt(1239)
			};
			Singleton<RoleMgr>.Ins.GetRole().AddEffect(RoleIncType.AttrEachRoundInc, 11, increaserOther2, null);
			this.socialCntAddByDownFavorNpcUid = increaserOther2.uid;
		}
		EventMgr.Send(401);
	}

	// Token: 0x06000680 RID: 1664 RVA: 0x0003B3B6 File Offset: 0x000395B6
	public bool CanUnFocus(int _npcId)
	{
		return Singleton<RoleMgr>.Ins.GetRole(_npcId).canUnFocus;
	}

	// Token: 0x06000681 RID: 1665 RVA: 0x0003B3D0 File Offset: 0x000395D0
	public void RefreshSocialCapacity()
	{
		int num = 0;
		foreach (KeyValuePair<int, RelationCfg> keyValuePair in Cfg.RelationCfgMap)
		{
			if (keyValuePair.Value.socialCapacity != 0)
			{
				List<int> relationship = this.GetRelationship(keyValuePair.Key);
				if (relationship != null)
				{
					num += relationship.Count * keyValuePair.Value.socialCapacity;
				}
			}
		}
		int num2 = 5;
		int num3 = Mathf.Max(0, Singleton<RoleMgr>.Ins.GetRole().GetAttrRank(2).Item1 - 5) * (int)RoleMgr.GetConstValue(19);
		int num4 = (int)Singleton<RoleMgr>.Ins.GetRole().IncCtrl.GetValue(RoleIncType.OtherAttrInc, 400);
		this.socialCapacity = num2 + num3 + num4 - num;
		Utils.Log(new object[]
		{
			string.Format("刷新社交容量：{0} = 基础5 + 情商{1} + 额外{2} - 关系{3}", new object[]
			{
				this.socialCapacity,
				num3,
				num4,
				num
			})
		});
		this.setSocialCapacityDirty = false;
		if (this.socialCapacity < 0 && this.energyMaxDownByNegativeSocialCapacityEffectUid == 0UL)
		{
			IncreaserOther increaserOther = new IncreaserOther(null)
			{
				otherAttrId = 401,
				tag = DescCtrl.GetTxt(1226)
			};
			this.energyMaxDownByNegativeSocialCapacityEffectUid = increaserOther.uid;
			Singleton<RoleMgr>.Ins.GetRole().AddEffect(RoleIncType.AttrEachRoundInc, 11, increaserOther, null);
			Utils.Log(new object[]
			{
				"添加效果：负社交容量影响社交热情"
			});
		}
	}

	// Token: 0x06000682 RID: 1666 RVA: 0x0003B560 File Offset: 0x00039760
	public int GetSocialCapacity()
	{
		if (this.setSocialCapacityDirty)
		{
			this.RefreshSocialCapacity();
		}
		return this.socialCapacity;
	}

	// Token: 0x06000683 RID: 1667 RVA: 0x0003B578 File Offset: 0x00039778
	public void CheckSocialEvtRedpoint()
	{
		bool active = false;
		foreach (int num in this.GetOtherRelation(-3))
		{
			Role role = Singleton<RoleMgr>.Ins.GetRole(num);
			if (role == null)
			{
				Debug.LogError(string.Format("Can't Find Role:{0}", num));
			}
			else if ((role.socialEvtId > 0 || role.loveSocialEvtId > 0) && (this.showSocialEvtRedpointInThisRounds == null || !this.showSocialEvtRedpointInThisRounds.Contains(num)))
			{
				if (this.showSocialEvtRedpointInThisRounds == null)
				{
					this.showSocialEvtRedpointInThisRounds = new List<int>();
				}
				this.showSocialEvtRedpointInThisRounds.Add(num);
				active = true;
				break;
			}
		}
		RedpointHelper.Active(301, active, false);
	}

	// Token: 0x06000684 RID: 1668 RVA: 0x0003B648 File Offset: 0x00039848
	public void CheckNewFriendRedpoint()
	{
		float searchFriendNeedEQ = Singleton<RoleMgr>.Ins.GetRelationData(true).GetSearchFriendNeedEQ();
		bool active = Singleton<RoleMgr>.Ins.HasEnoughCost(2, searchFriendNeedEQ, false);
		RedpointHelper.Active(303, active, false);
	}

	// Token: 0x06000685 RID: 1669 RVA: 0x0003B680 File Offset: 0x00039880
	public void CheckRedpoint(RedpointTypeDefine _type, int _id)
	{
		if (_type == RedpointTypeDefine.Force)
		{
			this.CheckSocialEvtRedpoint();
			this.CheckNewFriendRedpoint();
			return;
		}
		if (_type == RedpointTypeDefine.AttrUpdate && _id == 2)
		{
			this.CheckNewFriendRedpoint();
		}
	}

	// Token: 0x06000686 RID: 1670 RVA: 0x0003B6A0 File Offset: 0x000398A0
	public bool IsNpcRedpointShow(int _id)
	{
		Role role = Singleton<RoleMgr>.Ins.GetRole(_id);
		if (role == null)
		{
			return false;
		}
		if (role.taskEvtId > 0)
		{
			return !this.npcEvtRedpoints.Contains(role.taskEvtId);
		}
		return (role.socialEvtId > 0 && !this.npcEvtRedpoints.Contains(role.socialEvtId)) || (role.loveSocialEvtId > 0 && !this.npcEvtRedpoints.Contains(role.loveSocialEvtId));
	}

	// Token: 0x06000687 RID: 1671 RVA: 0x0003B717 File Offset: 0x00039917
	public bool HasNpcEvtRedpoint(int _evtId)
	{
		return this.npcEvtRedpoints.Contains(_evtId);
	}

	// Token: 0x06000688 RID: 1672 RVA: 0x0003B725 File Offset: 0x00039925
	public void RemoveNpcRedpoint(int _evtId)
	{
		if (this.npcEvtRedpoints.Contains(_evtId))
		{
			this.npcEvtRedpoints.Remove(_evtId);
		}
	}

	// Token: 0x06000689 RID: 1673 RVA: 0x0003B742 File Offset: 0x00039942
	public void AddNpcRedpoint(int _evtId)
	{
		if (_evtId == 0)
		{
			return;
		}
		if (this.npcEvtRedpoints.Contains(_evtId))
		{
			return;
		}
		this.npcEvtRedpoints.Add(_evtId);
		EventMgr.Send(7004);
	}

	// Token: 0x0600068A RID: 1674 RVA: 0x0003B76D File Offset: 0x0003996D
	public override void NewRound()
	{
		this.jumpFocusViewThisRound = false;
		List<int> list = this.showSocialEvtRedpointInThisRounds;
		if (list != null)
		{
			list.Clear();
		}
		this.CheckSocialEvtRedpoint();
	}

	// Token: 0x0600068B RID: 1675 RVA: 0x0003B790 File Offset: 0x00039990
	public List<RelationCfg> GetOrderRelationCfgs()
	{
		if (this.orderRelationCfgs == null)
		{
			this.orderRelationCfgs = new List<RelationCfg>(Cfg.RelationCfgMap.Values);
			this.orderRelationCfgs.Sort((RelationCfg a, RelationCfg b) => a.condition.CompareTo(b.condition));
		}
		return this.orderRelationCfgs;
	}

	// Token: 0x0600068C RID: 1676 RVA: 0x0003B7EA File Offset: 0x000399EA
	public void CheckOldSave()
	{
		this.setSocialCapacityDirty = true;
	}

	// Token: 0x04000524 RID: 1316
	public Dictionary<int, List<int>> relationDict = new Dictionary<int, List<int>>();

	// Token: 0x04000525 RID: 1317
	public int lastInviteRound;

	// Token: 0x04000526 RID: 1318
	public int searchFriendCnt;

	// Token: 0x04000527 RID: 1319
	public int unFocusCnt;

	// Token: 0x04000528 RID: 1320
	[Obsolete]
	public int friendRewardId;

	// Token: 0x04000529 RID: 1321
	[Obsolete]
	public int bestFriendRewardId;

	// Token: 0x0400052A RID: 1322
	[Obsolete]
	public int intimateFriendRewardId;

	// Token: 0x0400052B RID: 1323
	[Obsolete]
	public int closeFriendRewardId;

	// Token: 0x0400052C RID: 1324
	private Dictionary<int, int> rewardIds;

	// Token: 0x0400052D RID: 1325
	[IgnoreMember]
	public List<int> showSocialEvtRedpointInThisRounds;

	// Token: 0x0400052E RID: 1326
	[IgnoreMember]
	public bool showFocusNpcViewInThisRound;

	// Token: 0x0400052F RID: 1327
	[IgnoreMember]
	private List<RelationCfg> orderRelationCfgs;

	// Token: 0x04000530 RID: 1328
	public int enableFocusCnt = 4;

	// Token: 0x04000531 RID: 1329
	public int specialMakeAcquinceMode;

	// Token: 0x04000532 RID: 1330
	private List<int> npcEvtRedpoints = new List<int>();

	// Token: 0x04000533 RID: 1331
	public bool jumpFocusViewThisRound;

	// Token: 0x04000534 RID: 1332
	private int socialCapacity;

	// Token: 0x04000535 RID: 1333
	public bool setSocialCapacityDirty = true;

	// Token: 0x04000536 RID: 1334
	private ulong energyMaxDownByNegativeSocialCapacityEffectUid;

	// Token: 0x04000537 RID: 1335
	private ulong socialCntAddByDownFavorNpcUid;
}
